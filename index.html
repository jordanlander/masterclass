<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Masterclass — Research → Slides → PPTX/ODP/PDF</title>

<!-- Icons (embedded SVG to avoid binary assets) -->
<link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJz48dGV4dCB5PScuOWVtJyBmb250LXNpemU9JzkwJz7wn46TPC90ZXh0Pjwvc3ZnPg=="/>
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJz48dGV4dCB5PScuOWVtJyBmb250LXNpemU9JzkwJz7wn46TPC90ZXh0Pjwvc3ZnPg=="/>
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJz48dGV4dCB5PScuOWVtJyBmb250LXNpemU9JzkwJz7wn46TPC90ZXh0Pjwvc3ZnPg=="/>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

<!-- Minimal, modern styles (no build step) -->
<style>
/* Root color variables */
:root{
  --bg:#0b1220; --muted:#94a3b8; --text:#ffffff;
  --brand:#1e3a8a; --accent:#f97316; --paper:#f5f7ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
.header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
.h1{font-size:28px;font-weight:800}
.card{background:linear-gradient(135deg, var(--brand), var(--accent));color:var(--text);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
.card .p{color:var(--text)}
.grid{display:grid;gap:16px}
.grid-2{grid-template-columns:420px 1fr}
.input,textarea,select{background:#0b1325;color:var(--text);border:1px solid #1f2937;border-radius:10px;padding:10px;width:100%}
.small{font-size:12px;color:var(--text)}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{background:var(--brand);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.secondary{background:#334155}
.btn.ghost{background:transparent;border:1px dashed #334155}
.progress{width:120px;height:8px;background:#334155;border-radius:4px;overflow:hidden}
.progress-bar{height:100%;width:0;background:var(--accent);transition:width .2s}
.popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center}
.popup-content{background:linear-gradient(135deg, var(--brand), var(--accent));color:var(--text);padding:24px;border-radius:12px;text-align:center}
.badge{background:#1e293b;padding:4px 8px;border-radius:999px;color:var(--text);font-size:12px}
.split{display:grid;grid-template-columns:420px 1fr;gap:16px}
.preview{background:white;border-radius:12px;overflow:auto;height:560px;padding:8px;color:#1e293b}
.slide-list{list-style:none;padding:0;margin:8px 0;max-height:160px;overflow:auto}
.slide-list li{padding:4px 8px;border-radius:6px;margin-bottom:4px;background:#1e293b;cursor:grab}
.slide-list li.active{background:var(--brand)}

/* ------------- SLIDE THEME (16:9, 1280x720) ------------- */
.slide-container{width:1280px;min-height:720px;position:relative;background:#fff;border-radius:12px;overflow:hidden}
.title-bar{background:var(--brand);height:12px}
.accent-bar{background:var(--accent);height:4px}
.footer-bar{background:var(--brand);height:40px;color:white;display:flex;align-items:center;justify-content:space-between;padding:0 16px;font-weight:700}
.icon-circle{width:80px;height:80px;border-radius:50%;background:#fff;border:2px solid var(--brand);display:flex;align-items:center;justify-content:center;font-size:36px}
.section-icon{width:120px;height:120px;border-radius:50%;background:#fff;border:3px solid var(--brand);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 6px rgba(0,0,0,.1);font-size:54px}
.bullet-point{position:relative;padding-left:28px;margin:6px 0;font-size:18px;line-height:1.5;font-weight:600;color:#1e293b}
.bullet-point::before{content:"";position:absolute;left:0;top:10px;width:8px;height:8px;background:var(--brand);border-radius:50%}
.hdr{font-family:Montserrat,Inter,sans-serif;color:#0b1220;font-weight:700}
.p{font-family:"Open Sans",Inter,sans-serif;color:#1e293b;line-height:1.5;font-weight:600}
/* Utility-ish */
.row{display:flex;gap:24px}
.col{display:flex;flex-direction:column}
.center{display:flex;align-items:center;justify-content:center}
.mt-2{margin-top:8px}.mt-3{margin-top:12px}.mt-4{margin-top:16px}.mt-6{margin-top:24px}
.mb-2{margin-bottom:8px}.mb-3{margin-bottom:12px}.mb-4{margin-bottom:16px}.mb-6{margin-bottom:24px}
.w-2-3{width:66.666%}.w-1-3{width:33.333%}
.w-full{width:100%}
.hidden{display:none}

#preview{
  --scale:1;
  height:calc(720px * var(--scale));
  overflow:hidden;
}
#preview .slide-container{
  transform:scale(var(--scale));
  transform-origin:top left;
}

@media (max-width:768px){
  .split{grid-template-columns:1fr}
  .grid-2{grid-template-columns:1fr}
  .header{flex-direction:column;align-items:flex-start}
  .toolbar{width:100%}
  .preview{height:auto;min-height:300px}
}

@media (min-width:769px) and (max-width:1024px){
  .split{grid-template-columns:300px 1fr}
  .grid-2{grid-template-columns:300px 1fr}
}
</style>

<!-- Client-side exporters -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="h1">Masterclass — one-file slide builder</div>
      <div class="toolbar">
        <select id="themeSelect" class="input" style="width:auto"></select>
        <button class="btn" id="btnDownloadJson">Download outline.json</button>
        <label class="small" style="display:flex;align-items:center;gap:4px"><input type="checkbox" id="leanToggle" checked/> Lean export</label>
        <button class="btn secondary" id="btnExportPPTX">Export PPTX</button>
        <button class="btn secondary" id="btnExportODP">Export ODP</button>
        <button class="btn secondary" id="btnExportPDF">Export PDF</button>
        <div id="progressWrap" class="progress hidden"><div id="progressBar" class="progress-bar"></div></div>
      </div>
    </header>

  <div class="card mb-4">
    <strong>Quickstart with AI</strong>
    <ol class="p" style="margin:8px 0 0 18px">
      <li>Download the <a href="masterclass_prompt_and_outline.md" download>Master Prompt + Outline Template</a> for a one-shot AI request and blank slide deck.</li>
      <li>Give the prompt and outline to your AI and let it fill the markdown with research, images <code>![](url)</code>, and video links.</li>
      <li>Paste the AI's markdown below and click <strong>Use Pasted Text</strong>.</li>
      <li>Review the slides, then export to PPTX, ODP or PDF.</li>
    </ol>
  </div>

    <div class="split">
      <!-- Left: import + meta + quick controls -->
      <div class="grid">
        <div class="card">
          <div class="toolbar" style="justify-content:space-between">
            <strong>Training Templates</strong>
          </div>
          <div class="toolbar mt-3">
            <a class="btn secondary" href="masterclass_prompt_and_outline.md" download>Prompt + Outline Template</a>
            <a class="btn secondary" href="masterclass_ai_authoring_spec.txt" download>AI Authoring Spec</a>
          </div>
        </div>
        <div class="card">
          <div class="toolbar" style="justify-content:space-between">
            <strong>Import</strong>
            <span class="badge">Paste Markdown or JSON • or drop a file</span>
          </div>
          <textarea id="pasteBox" rows="10" class="mt-2" placeholder="# Title
Subtitle
## Table of Contents
- Section A
- Section B
## Section A
### Topic A1
- Bullet 1
- Bullet 2"></textarea>
          <div class="toolbar mt-3">
            <button class="btn" id="btnUsePasted">Use Pasted Text</button>
            <button class="btn ghost" id="btnSample">Load Sample</button>
            <span class="small" id="status"></span>
          </div>
          <div class="small mt-3">Tip: JSON shape: {"meta":{...},"slides":[{ "template":"01_title", "data":{...} }...]}</div>
        </div>

        <div class="card">
          <div class="toolbar" style="justify-content:space-between">
            <strong>Slides</strong>
            <span class="badge" id="countBadge">0 items</span>
          </div>
          <ul id="slideList" class="slide-list"></ul>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
            <label class="small">Current Title</label>
            <label class="small">Template</label>
            <input id="titleInput" class="input"/>
              <select id="templateSelect" class="input">
                <option>01_title</option>
                <option>02_toc</option>
                <option>03_section</option>
                <option>04_two_col_bullets</option>
                <option>05_image_right_research</option>
                <option>06_quote</option>
                <option>07_checklist</option>
                <option>08_conclusion</option>
                <option>09_video</option>
                <option>10_table</option>
              </select>
            </div>
          <div class="toolbar mt-3" style="justify-content:space-between">
            <div class="toolbar">
              <button class="btn secondary" id="btnPrev">◀ Prev</button>
              <span class="badge" id="idxBadge">Slide 0 / 0</span>
              <button class="btn secondary" id="btnNext">Next ▶</button>
            </div>
            <div class="toolbar">
              <button class="btn ghost" id="btnAdd">+ Add Slide</button>
              <button class="btn ghost" id="btnDelete">Delete</button>
            </div>
          </div>
        </div>

        <div class="card">
          <strong>Meta</strong>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
            <input id="metaTitle" class="input" placeholder="Deck title"/>
            <input id="metaPresenter" class="input" placeholder="Presenter"/>
            <input id="metaOrg" class="input" placeholder="Organization"/>
            <input id="metaDate" class="input" placeholder="Date"/>
          </div>
        </div>
      </div>

      <!-- Right: preview -->
      <div class="grid">
        <div class="card">
          <div class="toolbar" style="justify-content:space-between">
            <strong>Preview</strong>
            <span class="small">16:9 • 1280×720</span>
          </div>
          <div id="preview" class="preview center">
            <div class="small">No slides yet. Paste Markdown or JSON to begin.</div>
          </div>
        </div>
      </div>
    </div>

    <p class="small mt-3">
      This is a single-file prototype for rapid authoring. Extend freely in Codespaces/Copilot.
      Exporters use client-side rendering via <code>html2canvas</code> + <code>pptxgenjs</code> / <code>jsPDF</code>.
    </p>
  </div>

  <!-- Hidden render stage for exports -->
  <div id="renderStage" class="hidden"></div>
  <div id="downloadPopup" class="popup hidden">
    <div class="popup-content">
      <p id="downloadMessage" class="mb-3"></p>
      <a id="downloadLink" class="btn" download>Download</a>
    </div>
  </div>

<script type="module">
let buildOdp, buildPptx;
import('./src/export/odpBuilder.js')
  .then(m => { buildOdp = m.buildOdp; })
  .catch(err => console.warn('ODP builder failed to load', err));
import('./src/export/pptxBuilder.js')
  .then(m => { buildPptx = m.buildPptx; })
  .catch(err => console.warn('PPTX builder failed to load', err));
/*** --------------------- OUTLINE + PARSER --------------------- ***/
let outline = { meta:{ title:"", presenter:"", org:"", date:"", theme:0 }, slides:[] };
let idx = 0;

function saveOutline(){
  localStorage.setItem('mc_outline', JSON.stringify(outline));
}
function loadOutline(){
  const saved = localStorage.getItem('mc_outline');
  if(saved){
    try{ outline = JSON.parse(saved); }
    catch(e){ console.error('Failed to parse saved outline', e); }
  }
}
loadOutline();

function setProgress(p){
  el.progressBar.style.width = `${p}%`;
}
function showProgress(){
  setProgress(0);
  el.progressWrap.classList.remove('hidden');
}
function hideProgress(){
  el.progressWrap.classList.add('hidden');
}

function showDownload(message, blob, name){
  if(el.downloadLink.href) URL.revokeObjectURL(el.downloadLink.href);
  const url = URL.createObjectURL(blob);
  el.downloadLink.href = url;
  el.downloadLink.download = name;
  el.downloadMessage.textContent = message;
  el.downloadPopup.classList.remove('hidden');
}
function closeDownload(){
  el.downloadPopup.classList.add('hidden');
  if(el.downloadLink.href){ URL.revokeObjectURL(el.downloadLink.href); el.downloadLink.href = ""; }
}

const themes = [
  { name:"Royal Blue", brand:"#1e3a8a", accent:"#f97316" },
  { name:"Forest Green", brand:"#15803d", accent:"#facc15" },
  { name:"Purple Magenta", brand:"#6d28d9", accent:"#ec4899" },
  { name:"Crimson Amber", brand:"#b91c1c", accent:"#f59e0b" },
  { name:"Indigo Teal", brand:"#4338ca", accent:"#14b8a6" },
  { name:"Rose Violet", brand:"#be123c", accent:"#a78bfa" },
  { name:"Navy Coral", brand:"#1e293b", accent:"#fb7185" },
  { name:"Emerald Peach", brand:"#047857", accent:"#fb923c" },
  { name:"Slate Sky", brand:"#334155", accent:"#0ea5e9" },
  { name:"Maroon Lime", brand:"#7f1d1d", accent:"#84cc16" },
];

function applyTheme(t){
  document.documentElement.style.setProperty('--brand', t.brand);
  document.documentElement.style.setProperty('--accent', t.accent);
}

function mdToOutline(md){
  const lines = md.split(/\r?\n/);
  const slides = [];
  let titleCaptured = false;

  function getList(start){
    const out = [];
    let i = start;
    let tableMode = false;
    for(; i<lines.length; i++){
      const L = lines[i];
      if(/^\s*-\s+/.test(L)){
        const item = L.replace(/^\s*-\s+/, '').trim();
        out.push(item);
        tableMode = /^TABLE:/i.test(item);
      }else if(tableMode && /^\s*\|/.test(L)){
        out.push(L.trim());
      }else if(/^#/.test(L) || !L.trim()){
        break;
      }else{
        break;
      }
    }
    getList.next = i;
    return out;
  }

  for(let i=0;i<lines.length;i++){
    const L = lines[i];

    if(/^#\s+/.test(L) && !titleCaptured){
      const h1 = L.replace(/^#\s+/, '').trim();
      slides.push({ template:"01_title", data:{ h1, subtitle: lines[i+1] && !/^#/.test(lines[i+1]) ? lines[i+1].trim() : "" }});
      titleCaptured = true;
      continue;
    }

    if(/^##\s+Table of Contents/i.test(L)){
      const items = getList(i+1);
      const next = getList.next;
      slides.push({ template:"02_toc", data:{ h1:"Table of Contents", items }});
      i = next - 1;
      continue;
    }

    if(/^##\s+/.test(L)){
      const h2 = L.replace(/^##\s+/, '').trim();
      slides.push({ template:"03_section", data:{ h1:h2, tagline:"", icon:"" }});
      continue;
    }

    if(/^###\s+/.test(L)){
      const h3 = L.replace(/^###\s+/, '').trim();

      // Quote slide
      if(/^quote$/i.test(h3)){
        const line = (lines[i+1]||'').trim();
        const cleaned = line.replace(/^[^\w"“]+/, '').replace(/\*/g, '').trim();
        const parts = cleaned.split(/\s+[\-–—]\s+/);
        const quote = parts[0] || '';
        const by = parts[1] || '';
        slides.push({ template:"06_quote", data:{ quote, by } });
        i += 1;
        continue;
      }

      // Reflective question slide
      if(/reflect/i.test(h3)){
        const line = (lines[i+1]||'').trim();
        const quote = line.replace(/^[^\w"“]+/, '').replace(/\*/g, '').trim();
        slides.push({ template:"06_quote", data:{ quote, by:"" } });
        i += 1;
        continue;
      }

      const raw = getList(i+1);
      const next = getList.next;
      const data = { h1:h3, subtitle:"", bullets:[], icon:"", caption:"" };
      let tableMode = false;
      raw.forEach(b=>{
        if(/^TABLE:/i.test(b)){
          tableMode = true;
          data.table = { headers:[], rows:[] };
        }else if(tableMode && /^\|/.test(b)){
          const cells = b.split('|').slice(1,-1).map(c=>c.trim());
          if(!data.table.headers.length) data.table.headers = cells;
          else data.table.rows.push(cells);
        }else{
          tableMode = false;
          if(/^VIDEO:/i.test(b)){
            data.video = b.replace(/^VIDEO:\s*/i, '').trim();
          }else if(/^NOTE:/i.test(b)){
            data.notes = data.notes || [];
            data.notes.push(b.replace(/^NOTE:\s*/i, '').trim());
          }else if(/^LINK:/i.test(b)){
            const rest = b.replace(/^LINK:\s*/i, '').trim();
            const [label,url] = rest.split(/\s*\|\s*/);
            if(label && url){
              data.links = data.links || [];
              data.links.push({label, url});
            }
          }else if(/^IMG:/i.test(b)){
            const rest = b.replace(/^IMG:\s*/i, '').trim();
            const [url,cap] = rest.split(/\s*\|\s*/);
            if(url){ data.image = url; if(cap) data.caption = cap; }
          }else{
            data.bullets.push(b);
          }
        }
      });
      i = next - 1;
      if(data.table){
        slides.push({ template:"10_table", data });
      }else if(!data.bullets.length && data.video && !(data.links||data.image)){
        slides.push({ template:"09_video", data:{ h1:h3, youtube:data.video, notes:data.notes||[] }});
      }else{
        slides.push({ template:"04_two_col_bullets", data });
      }
      continue;
    }
  }

  return { meta:{ title:"" }, slides };
}

/*** --------------------- TEMPLATES --------------------- ***/
function fmt(text){
  return text ? text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') : '';
}
function slideHTML(s){
  const d = s.data || {};
  const begin = `
  <div class="slide-container">
    <div class="title-bar"></div>
    <div class="accent-bar"></div>
    <div style="min-height:620px;padding:40px">`;

  const end = `
    </div>
    <div class="accent-bar"></div>
    <div class="footer-bar"><span>Masterclass</span><span>Create → Teach → Impact</span></div>
  </div>`;

  switch(s.template){
    case "01_title":
      return `
      ${begin}
        <div class="center col" style="gap:16px;text-align:center;height:540px">
          <div class="row center" style="gap:48px">
            <div class="icon-circle">📖</div><div class="icon-circle">👩‍🏫</div><div class="icon-circle">👥</div>
          </div>
          <h1 class="hdr" style="font-size:48px;margin:8px 0 4px">${fmt(d.h1||"")}</h1>
          <p class="p" style="font-size:20px;max-width:900px;margin:0 auto">${fmt(d.subtitle||"")}</p>
        </div>
      ${end}`;
    case "02_toc":
      const items = (d.items||[]);
      const half = Math.ceil(items.length/2);
      return `
      ${begin}
        <h1 class="hdr" style="font-size:36px;margin:0 0 12px">${fmt(d.h1||"Table of Contents")}</h1>
        <div class="row" style="gap:24px">
          <div class="col" style="flex:1">
            ${items.slice(0,half).map((t,i)=>`
              <div class="row" style="align-items:center;gap:8px">
                <span class="icon-circle" style="width:32px;height:32px;font-size:14px;border-width:0;background:var(--brand);color:#fff">${i+1}</span>
                <span class="p" style="font-weight:700">${fmt(t)}</span>
              </div>`).join("")}
          </div>
          <div class="col" style="flex:1">
            ${items.slice(half).map((t,i)=>`
              <div class="row" style="align-items:center;gap:8px">
                <span class="icon-circle" style="width:32px;height:32px;font-size:14px;border-width:0;background:var(--brand);color:#fff">${i+1+half}</span>
                <span class="p" style="font-weight:700">${fmt(t)}</span>
              </div>`).join("")}
          </div>
        </div>
      ${end}`;
    case "03_section":
      return `
      ${begin}
        <div class="row" style="align-items:center;height:540px">
          <div class="col" style="flex:2;padding-right:24px">
            <h1 class="hdr" style="font-size:60px;margin:0 0 12px">${fmt(d.h1||"")}</h1>
            <div style="width:120px;height:6px;background:var(--accent);margin-bottom:12px"></div>
            <p class="p" style="font-size:22px;max-width:640px">${fmt(d.tagline||"")}</p>
          </div>
          <div class="center" style="flex:1">
            <div class="section-icon">${d.icon||"🧩"}</div>
          </div>
        </div>
      ${end}`;
    case "04_two_col_bullets":
      return `
      ${begin}
        <h1 class="hdr" style="font-size:32px;margin:0 0 8px">${fmt(d.h1||"")}</h1>
        <p class="p" style="font-size:18px;margin:0 0 12px">${fmt(d.subtitle||"")}</p>
        <div class="row" style="gap:24px">
          <div style="flex:3">
            ${(d.bullets||[]).map(b=>`<p class="bullet-point">${fmt(b)}</p>`).join("")}
            ${(d.links||[]).map(l=>`<p class="p"><a data-href="${l.url}" href="${l.url}" target="_blank">${fmt(l.label)}</a></p>`).join("")}
            ${d.video ? `<p class="p"><a data-href="${d.video}" href="${d.video}" target="_blank">Video ▶</a></p>`:""}
            ${d.highlight ? `
              <div style="margin-top:12px;padding:12px;background:var(--paper);border-left:4px solid var(--brand);border-radius:8px">
                <p class="hdr" style="font-size:18px;margin:0 0 6px">${fmt(d.highlight.title||"Key Consideration:")}</p>
                <p class="p" style="margin:0">${fmt(d.highlight.text||"")}</p>
              </div>` : ""}
          </div>
          <div style="flex:2">
            ${d.image ? `<img src="${d.image}" style="width:100%;height:280px;object-fit:cover;border:1px solid #e2e8f0;border-radius:10px"/>`
                      : `<div class="center" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;height:280px;font-size:48px;color:#1e293b">🖼️</div>`}
            <p style="text-align:center;margin-top:6px;font-size:12px;color:#1e293b">${fmt(d.caption||"")}</p>
          </div>
        </div>
      ${end}`;
    case "05_image_right_research":
      return `
      ${begin}
        <h1 class="hdr" style="font-size:32px;margin:0 0 8px">${fmt(d.h1||"")}</h1>
        <p class="p" style="font-size:18px;margin:0 0 12px">${fmt(d.subtitle||"")}</p>
        <div class="row" style="gap:24px">
          <div style="flex:3">
            ${(d.bullets||[]).map(b=>`<p class="bullet-point">${fmt(b)}</p>`).join("")}
            ${(d.links||[]).map(l=>`<p class="p"><a data-href="${l.url}" href="${l.url}" target="_blank">${fmt(l.label)}</a></p>`).join("")}
            ${d.video ? `<p class="p"><a data-href="${d.video}" href="${d.video}" target="_blank">Video ▶</a></p>`:""}
            <div style="margin-top:12px;padding:12px;background:var(--paper);border-left:4px solid var(--brand);border-radius:8px">
              <p class="hdr" style="font-size:18px;margin:0 0 6px">Research Shows:</p>
              <p class="p" style="margin:0">${fmt(d.research||"")}</p>
            </div>
          </div>
          <div style="flex:2">
            ${d.image ? `<img src="${d.image}" style="width:100%;height:280px;object-fit:cover;border:1px solid #e2e8f0;border-radius:10px"/>`
                      : `<div class="center" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;height:280px;font-size:48px;color:#1e293b">🤝</div>`}
            <p style="text-align:center;margin-top:6px;font-size:12px;color:#1e293b">${fmt(d.caption||"")}</p>
          </div>
        </div>
      ${end}`;
    case "06_quote":
      return `
      ${begin}
        <div class="center" style="height:540px;text-align:center">
          <div style="max-width:900px">
            <div class="hdr" style="font-size:28px;color:var(--brand)">“</div>
            <h2 class="hdr" style="font-size:38px;margin:0 0 8px">${fmt(d.quote||"")}</h2>
            <p class="p">— ${fmt(d.by||"Unknown")}</p>
          </div>
        </div>
      ${end}`;
    case "07_checklist":
      return `
      ${begin}
        <h1 class="hdr" style="font-size:32px;margin:0 0 8px">${fmt(d.h1||"")}</h1>
        <ul style="padding:0;margin:0;list-style:none">
          ${(d.items||[]).map(t=>`<li class="row" style="gap:8px;align-items:flex-start;margin:6px 0">✅<span class="p" style="font-size:18px">${fmt(t)}</span></li>`).join("")}
        </ul>
      ${end}`;
      case "08_conclusion":
        return `
        ${begin}
          <h1 class="hdr" style="font-size:32px;margin:0 0 8px">${fmt(d.h1||"Conclusion")}</h1>
        <div class="row" style="gap:24px">
          <div style="flex:1">
            <h3 class="hdr" style="font-size:20px;margin:0 0 6px">Key Takeaways</h3>
            <ul class="p" style="margin:0 0 8px 18px">${(d.takeaways||[]).map(t=>`<li>${fmt(t)}</li>`).join("")}</ul>
          </div>
          <div style="flex:1">
            <h3 class="hdr" style="font-size:20px;margin:0 0 6px">Action Plan</h3>
            <p class="p"><strong>Goal:</strong> ${fmt(d.goal||"")}</p>
            <ul class="p" style="margin:0 0 8px 18px">${(d.steps||[]).map(s=>`<li>${fmt(s)}</li>`).join("")}</ul>
          </div>
        </div>
        ${end}`;
      case "10_table":
        return `
        ${begin}
          <h1 class="hdr" style="font-size:32px;margin:0 0 8px">${fmt(d.h1||"")}</h1>
          ${(d.bullets||[]).map(b=>`<p class="bullet-point">${fmt(b)}</p>`).join("")}
          ${d.table?`<table style="width:100%;border-collapse:collapse;margin-top:16px;color:#1e293b"><thead><tr>${(d.table.headers||[]).map(h=>`<th style="border:1px solid #1e293b;padding:4px;background:var(--paper);color:#1e293b">${fmt(h)}</th>`).join("")}</tr></thead><tbody>${(d.table.rows||[]).map(r=>`<tr>${r.map(c=>`<td style="border:1px solid #1e293b;padding:4px;color:#1e293b">${fmt(c)}</td>`).join("")}</tr>`).join("")}</tbody></table>`:""}
        ${end}`;
      case "09_video": {
        const m = (d.youtube||"").match(/(?:youtu.be\/|watch\?v=|embed\/)([^?&]+)/);
        const id = m ? m[1] : "";
        return `
        ${begin}
          <h1 class="hdr" style="font-size:32px;margin:0 0 12px">${fmt(d.h1||"")}</h1>
        <div class="center" style="height:540px">
          <a data-href="${d.youtube}" href="${d.youtube}" target="_blank" style="position:relative;display:block;width:800px;height:450px;border-radius:8px;overflow:hidden">
            <img src="${id?`https://img.youtube.com/vi/${id}/0.jpg`:""}" style="width:100%;height:100%;object-fit:cover"/>
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:64px;color:white;text-shadow:0 0 6px rgba(0,0,0,.5)">▶</div>
          </a>
        </div>
      ${end}`;
    }
    default:
      return `${begin}<p class="p">Unknown template: ${s.template}</p>${end}`;
  }
}

/*** --------------------- UI BINDINGS --------------------- ***/
const el = {
  pasteBox: document.getElementById('pasteBox'),
  btnUsePasted: document.getElementById('btnUsePasted'),
  btnSample: document.getElementById('btnSample'),
  status: document.getElementById('status'),
  preview: document.getElementById('preview'),
  idxBadge: document.getElementById('idxBadge'),
    countBadge: document.getElementById('countBadge'),
    slideList: document.getElementById('slideList'),
    titleInput: document.getElementById('titleInput'),
  templateSelect: document.getElementById('templateSelect'),
  btnPrev: document.getElementById('btnPrev'),
  btnNext: document.getElementById('btnNext'),
  btnAdd: document.getElementById('btnAdd'),
  btnDelete: document.getElementById('btnDelete'),
  metaTitle: document.getElementById('metaTitle'),
  metaPresenter: document.getElementById('metaPresenter'),
  metaOrg: document.getElementById('metaOrg'),
  metaDate: document.getElementById('metaDate'),
  btnDownloadJson: document.getElementById('btnDownloadJson'),
  btnExportPPTX: document.getElementById('btnExportPPTX'),
  btnExportODP: document.getElementById('btnExportODP'),
  btnExportPDF: document.getElementById('btnExportPDF'),
  leanToggle: document.getElementById('leanToggle'),
  themeSelect: document.getElementById('themeSelect'),
  renderStage: document.getElementById('renderStage'),
  progressWrap: document.getElementById('progressWrap'),
  progressBar: document.getElementById('progressBar'),
  downloadPopup: document.getElementById('downloadPopup'),
  downloadLink: document.getElementById('downloadLink'),
  downloadMessage: document.getElementById('downloadMessage'),
};

el.downloadLink.addEventListener('click', ()=>{ setTimeout(closeDownload,100); });
el.downloadPopup.addEventListener('click', e=>{ if(e.target===el.downloadPopup) closeDownload(); });

function updatePreviewScale(){
  const width = el.preview.clientWidth;
  const scale = Math.min(1, width / 1280);
  el.preview.style.setProperty('--scale', scale);
}
window.addEventListener('resize', updatePreviewScale);

themes.forEach((t,i)=>{
  const opt = document.createElement('option');
  opt.value = i;
  opt.textContent = t.name;
  el.themeSelect.appendChild(opt);
});
const optRandom = document.createElement('option');
optRandom.value = 'random';
optRandom.textContent = 'Random';
el.themeSelect.appendChild(optRandom);

if(outline.meta.theme == null) outline.meta.theme = 0;
applyTheme(themes[outline.meta.theme]);
el.themeSelect.value = outline.meta.theme;

el.themeSelect.onchange = ()=>{
  let val = el.themeSelect.value;
  if(val === 'random'){
    val = Math.floor(Math.random()*themes.length).toString();
    el.themeSelect.value = val;
  }
  outline.meta.theme = parseInt(val,10);
  applyTheme(themes[outline.meta.theme]);
  saveOutline();
  refreshUI();
};

function refreshUI(){
  updatePreviewScale();
  if(!outline.meta) outline.meta = {};
  if(!Array.isArray(outline.slides)) outline.slides = [];
  outline.meta.theme ??= 0;
  el.themeSelect.value = outline.meta.theme;
  saveOutline();
  el.countBadge.textContent = `${outline.slides.length} items`;
  el.slideList.innerHTML = "";
  outline.slides.forEach((s,i)=>{
    const li = document.createElement('li');
    li.innerHTML = `${i+1}. ${fmt(s.data?.h1 || s.data?.title || `Slide ${i+1}`)}`;
    li.dataset.index = i;
    li.draggable = true;
    if(i===idx) li.classList.add('active');
    el.slideList.appendChild(li);
  });
  if(outline.slides.length===0){
    el.preview.innerHTML = `<div class="small">No slides yet. Paste Markdown or JSON to begin.</div>`;
    el.idxBadge.textContent = `Slide 0 / 0`;
    el.titleInput.value = "";
    el.templateSelect.value = "01_title";
    return;
  }
  idx = Math.max(0, Math.min(idx, outline.slides.length-1));
  const s = outline.slides[idx];
  el.idxBadge.textContent = `Slide ${idx+1} / ${outline.slides.length}`;
  el.titleInput.value = s.data?.h1 || s.data?.title || `Slide ${idx+1}`;
  el.templateSelect.value = s.template;
  // render
  el.preview.innerHTML = slideHTML(s);
  // meta
  el.metaTitle.value = outline.meta.title||"";
  el.metaPresenter.value = outline.meta.presenter||"";
  el.metaOrg.value = outline.meta.org||"";
  el.metaDate.value = outline.meta.date||"";
}

function useText(txt){
  try{
    if(txt.trim().startsWith("{")){
      outline = JSON.parse(txt);
    } else {
      outline = mdToOutline(txt);
    }
    if(!outline.meta) outline.meta = {};
    if(!Array.isArray(outline.slides)) outline.slides = [];
    if(outline.slides.length===0){
      // Make sure at least a title slide exists
      outline.slides.push({ template:"01_title", data:{ h1: outline.meta.title || "Untitled", subtitle:"" }});
    }
    idx = 0;
    el.status.textContent = "✅ Parsed input";
    refreshUI();
  }catch(e){
    console.error(e);
    el.status.textContent = "❌ Could not parse input (Markdown or JSON expected)";
  }
}

/*** Events ***/
el.btnUsePasted.onclick = ()=> useText(el.pasteBox.value);
el.btnSample.onclick = ()=>{
  const sample = `---
title: Best Practices for Paraprofessionals in PreK-12
presenter: Jordan Lander
org: Masterclass
date: Aug 16, 2025
---
# Best Practices for Paraprofessionals in Pre-K-12 Classrooms
A comprehensive guide to enhancing student success through effective support strategies.

## Table of Contents
- Introduction & Overview
- Roles & Responsibilities
- Inclusive Practices
- Behavior Interventions
- Data & Assessment

## Introduction
### What Is a Paraprofessional?
- Supports teachers and students in classrooms
- Works under supervision; role varies by need

### Why Paraprofessionals Are Critical
- Post-pandemic support and SEL needs
- Individualized attention and inclusion
`;
  el.pasteBox.value = sample;
  useText(sample);
};

el.titleInput.oninput = (e)=>{
  if(!outline.slides[idx]) return;
  outline.slides[idx].data = outline.slides[idx].data || {};
  outline.slides[idx].data.h1 = e.target.value;
  refreshUI();
};
el.templateSelect.onchange = (e)=>{
  if(!outline.slides[idx]) return;
  outline.slides[idx].template = e.target.value;
  refreshUI();
};
el.btnPrev.onclick = ()=>{ idx = Math.max(0, idx-1); refreshUI(); };
el.btnNext.onclick = ()=>{ idx = Math.min((outline.slides.length-1)||0, idx+1); refreshUI(); };
el.btnAdd.onclick = ()=>{
  outline.slides.splice(idx+1, 0, { template:"03_section", data:{ h1:"New Section", tagline:"" }});
  idx++;
  refreshUI();
};
el.btnDelete.onclick = ()=>{
  if(!outline.slides[idx]) return;
  outline.slides.splice(idx,1);
  idx = Math.max(0, idx-1);
  refreshUI();
};
el.metaTitle.oninput = e=>{ outline.meta.title = e.target.value; refreshUI(); };
el.metaPresenter.oninput = e=>{ outline.meta.presenter = e.target.value; refreshUI(); };
el.metaOrg.oninput = e=>{ outline.meta.org = e.target.value; refreshUI(); };
el.metaDate.oninput = e=>{ outline.meta.date = e.target.value; refreshUI(); };

let dragIndex = null;
el.slideList.addEventListener('click', e=>{
  const li = e.target.closest('li');
  if(!li) return;
  idx = Number(li.dataset.index);
  refreshUI();
});
el.slideList.addEventListener('dragstart', e=>{
  const li = e.target.closest('li');
  if(!li) return;
  dragIndex = Number(li.dataset.index);
});
el.slideList.addEventListener('dragover', e=>{ e.preventDefault(); });
el.slideList.addEventListener('drop', e=>{
  e.preventDefault();
  const li = e.target.closest('li');
  let to = li ? Number(li.dataset.index) : outline.slides.length;
  if(dragIndex===null) return;
  const current = outline.slides[idx];
  const slide = outline.slides.splice(dragIndex,1)[0];
  outline.slides.splice(dragIndex < to ? to-1 : to, 0, slide);
  idx = outline.slides.indexOf(current);
  dragIndex = null;
  refreshUI();
});

document.addEventListener('keydown', e=>{
  if(!e.altKey) return;
  if(e.key === 'ArrowUp'){
    e.preventDefault();
    if(idx>0){
      const slide = outline.slides.splice(idx,1)[0];
      outline.slides.splice(idx-1,0,slide);
      idx--;
      refreshUI();
    }
  } else if(e.key === 'ArrowDown'){
    e.preventDefault();
    if(idx<outline.slides.length-1){
      const slide = outline.slides.splice(idx,1)[0];
      outline.slides.splice(idx+1,0,slide);
      idx++;
      refreshUI();
    }
  }
});

el.btnDownloadJson.onclick = ()=>{
  const blob = new Blob([JSON.stringify(outline,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "outline.json";
  a.click();
};

/*** --------------------- EXPORT: PPTX --------------------- ***/
async function imgToDataURL(url){
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 10000);
  try{
    const res = await fetch(url, { mode: "cors", signal: controller.signal });
    if(!res.ok) return "";
    const blob = await res.blob();
    return await new Promise(resolve => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.readAsDataURL(blob);
    });
  }catch{
    return "";
  }finally{
    clearTimeout(timeout);
  }
}

async function inlineSlideImages(container){
  const imgs = Array.from(container.querySelectorAll("img[src]"));
  for (const im of imgs){
    const src = im.getAttribute("src") || "";
    if (!src || src.startsWith("data:")) continue;
    im.setAttribute("crossorigin","anonymous");
    const data = await imgToDataURL(src);
    if (data) im.setAttribute("src", data);
  }
}

async function inlineModelImages(slides){
  for(const slide of slides){
    if(!slide || !slide.elements) continue;
    for(const el of slide.elements){
      if(el.type !== 'image') continue;
      const src = el.src || '';
      if(!src || src.startsWith('data:') || !/^https?:/i.test(src)) continue;
      const data = await imgToDataURL(src);
      if(data) el.src = data;
    }
  }
}

async function renderAllToImages(opt={}){
  const stage = el.renderStage;
  stage.innerHTML = "";
  stage.classList.remove("hidden");

  const images = [];
  const hotspotsBySlide = [];
  const lean = opt.lean;

  for (let i = 0; i < outline.slides.length; i++){
    const s = outline.slides[i];
    const container = document.createElement("div");
    Object.assign(container.style,{
      width:"1280px", height:"720px", position:"absolute", left:"-99999px"
    });
    container.innerHTML = slideHTML(s);
    stage.appendChild(container);

    await inlineSlideImages(container);
    await new Promise(r=>setTimeout(r, 20));

    const rects = [];
    const root = container.querySelector(".slide-container") || container;
    const rootRect = root.getBoundingClientRect();
    container.querySelectorAll("[data-href]").forEach(a=>{
      const r = a.getBoundingClientRect();
      rects.push({
        x: r.left - rootRect.left,
        y: r.top  - rootRect.top,
        w: r.width,
        h: r.height,
        url: a.getAttribute("href")
      });
    });
    hotspotsBySlide.push(rects);

    const canvas = await html2canvas(container, {
      backgroundColor: "#ffffff",
      scale: lean?1:2,
      useCORS: true,
      allowTaint: false
    });
    images.push(canvas.toDataURL("image/png"));
    container.remove();
  }
  stage.classList.add("hidden");
  return { images, hotspotsBySlide };
}

function outlineToPptxSlides(outline){
  const slides = [];
  const fallback = [];
  outline.slides.forEach((s,i)=>{
    const d = s.data || {};
    const notes = d.notes || [];
    switch(s.template){
      case "01_title":
        slides[i] = { elements:[
          { type:"title", text:d.h1 || "" },
          ...(d.subtitle?[{ type:"text", text:d.subtitle, options:{ fontSize:24 } }]:[])
        ], notes };
        break;
      case "02_toc":
        slides[i] = { elements:[
          { type:"title", text:d.h1 || "Table of Contents" },
          ...(d.items && d.items.length ? [{ type:"text", text:d.items.join("\n"), options:{ bullet:true } }] : [])
        ], notes };
        break;
      case "03_section":
        slides[i] = { elements:[
          { type:"title", text:d.h1 || "" },
          ...(d.tagline?[{ type:"text", text:d.tagline }]:[])
        ], notes };
        break;
      case "04_two_col_bullets": {
        const elements = [
          { type: "title", text: d.h1 || "" },
          ...(d.subtitle ? [{ type: "text", text: d.subtitle, options: { fontSize: 24 } }] : []),
          ...(d.bullets && d.bullets.length
            ? [{ type: "text", text: d.bullets.join("\n"), options: { bullet: true, w: 4.5 } }]
            : []),
          ...(d.links && d.links.length
            ? [{ type: "text", text: d.links.map(l => `${l.label}: ${l.url}`).join("\n"), options: { w: 4.5, fontSize: 14 } }]
            : []),
          ...(d.video ? [{ type: "text", text: d.video, options: { w: 4.5, fontSize: 14 } }] : []),
          ...(d.highlight
            ? [
                { type: "text", text: d.highlight.title || "Key Consideration:", options: { w: 4.5, fontSize: 18, bold: true } },
                { type: "text", text: d.highlight.text || "", options: { w: 4.5 } }
              ]
            : [])
        ];
        if (d.image) {
          elements.push({ type: "image", src: d.image, options: { x: 5.5, y: 1.5, w: 4, h: 3 } });
          if (d.caption) {
            elements.push({ type: "text", text: d.caption, options: { x: 5.5, y: 4.6, w: 4, fontSize: 12 } });
          }
        }
        if (d.table) {
          const tableText = [
            (d.table.headers || []).join(" | "),
            ...(d.table.rows || []).map(r => r.join(" | "))
          ].join("\n");
          if (tableText) {
            elements.push({ type: "text", text: tableText, options: { w: 4.5, fontSize: 14 } });
          }
        }
        slides[i] = { elements, notes };
        break;
      }
      case "05_image_right_research":
        slides[i] = { elements:[
          { type:"title", text:d.h1 || "" },
          ...(d.subtitle ? [{ type:"text", text:d.subtitle, options:{ fontSize:24 } }] : []),
          ...(d.bullets && d.bullets.length ? [{ type:"text", text:d.bullets.join("\n"), options:{ bullet:true, w:5 } }] : []),
          ...(d.research ? [{ type:"text", text:`Research Shows:\n${d.research}`, options:{ w:5 } }] : []),
          ...(d.image ? [
            { type:"image", src:d.image, options:{ x:5.5, y:1.5, w:4, h:3 } },
            ...(d.caption ? [{ type:"text", text:d.caption, options:{ x:5.5, y:4.6, w:4, fontSize:12 } }] : [])
          ] : [])
        ], notes };
        break;
      case "06_quote":
        slides[i] = { elements:[
          { type:"text", text:d.quote || "", options:{ fontSize:32, italic:true, align:'center', y:2 } },
          ...(d.by ? [{ type:"text", text:`— ${d.by}`, options:{ align:'center', y:3 } }] : [])
        ], notes };
        break;
      case "07_checklist":
        slides[i] = { elements:[
          { type:"title", text:d.h1 || "" },
          ...(d.items && d.items.length ? [{ type:"text", text:d.items.join("\n"), options:{ bullet:true } }] : [])
        ], notes };
        break;
      case "08_conclusion":
        slides[i] = { elements:[
          { type:"title", text:d.h1 || "Conclusion" },
          ...(d.takeaways && d.takeaways.length ? [
            { type:"text", text:"Key Takeaways", options:{ fontSize:20 } },
            { type:"text", text:d.takeaways.join("\n"), options:{ bullet:true } }
          ] : []),
          ...((d.goal || (d.steps && d.steps.length)) ? [
            { type:"text", text:"Action Plan", options:{ fontSize:20 } },
            ...(d.goal ? [{ type:"text", text:`Goal: ${d.goal}` }] : []),
            ...(d.steps && d.steps.length ? [{ type:"text", text:d.steps.join("\n"), options:{ bullet:true } }] : [])
          ] : [])
        ], notes };
        break;
      case "09_video": {
        const m = (d.youtube||"").match(/(?:youtu.be\/|watch\?v=|embed\/)([^?&]+)/);
        const id = m ? m[1] : "";
        slides[i] = { elements:[
          { type:"title", text:d.h1 || "" },
          ...(id ? [{ type:"image", src:`https://img.youtube.com/vi/${id}/0.jpg`, options:{ x:1, y:1.5, w:8, h:4.5 } }] : []),
          ...(d.youtube ? [{ type:"text", text:d.youtube, options:{ y:6.2, align:'center', fontSize:14 } }] : [])
        ], notes };
        break;
      }
      case "10_table": {
        const tableText = d.table ? [
          (d.table.headers || []).join(" | "),
          ...(d.table.rows || []).map(r=>r.join(" | "))
        ].join("\n") : "";
        slides[i] = { elements:[
          { type:"title", text:d.h1 || "" },
          ...(d.bullets && d.bullets.length ? [{ type:"text", text:d.bullets.join("\n"), options:{ bullet:true } }] : []),
          ...(tableText ? [{ type:"text", text:tableText, options:{ fontSize:14 } }] : [])
        ], notes };
        break;
      }
      default:
        fallback.push(i);
        slides[i] = null;
    }
  });
  const footerLeft = [outline.meta?.org, outline.meta?.presenter].filter(Boolean).join(' — ');
  const footerRight = outline.meta?.date || '';
  slides.forEach(sl=>{
    if(sl && sl.elements){
      if(footerLeft) sl.elements.push({ type:'footer', text:footerLeft, options:{ x:0.3, y:5.4, w:4.5 } });
      if(footerRight) sl.elements.push({ type:'footer', text:footerRight, options:{ x:5.2, y:5.4, w:4.5, align:'right' } });
    }
  });
  return { slides, fallback };
}

el.btnExportPPTX.onclick = async ()=>{
  if(!buildPptx){
    alert('PPTX exporter not available');
    return;
  }
  try{
    showProgress();
    const { slides, fallback } = outlineToPptxSlides(outline);
    let images = [];
    if(fallback.length){
      el.status.textContent = "⏳ Rendering slides…";
      setProgress(50);
      ({ images } = await renderAllToImages({ lean: el.leanToggle.checked }));
      fallback.forEach(i=>{ slides[i] = { src: images[i], notes: outline.slides[i].data.notes || [] }; });
    }
    await inlineModelImages(slides);
    el.status.textContent = "⏳ Building PPTX…";
    setProgress(90);
    const pptx = buildPptx(slides, { title: outline.meta.title });
    const name = (outline.meta.title || "Masterclass") + ".pptx";
    await pptx.writeFile({ fileName: name });
    setProgress(100);
    hideProgress();
    el.status.textContent = "✅ PPTX saved";
  }catch(err){
    console.error(err);
    hideProgress();
    alert("PPTX export failed. Open the console for details.");
    el.status.textContent = "❌ PPTX export failed";
  }
};

/*** --------------------- EXPORT: ODP --------------------- ***/
el.btnExportODP.onclick = async ()=>{
  if(!buildOdp){
    alert('ODP exporter not available');
    return;
  }
  try {
    showProgress();
    el.status.textContent = "⏳ Rendering slides…";
    const { images } = await renderAllToImages({ lean: el.leanToggle.checked });
    el.status.textContent = "⏳ Building ODP…";
    setProgress(90);
    const slides = images.map((src, i) => ({ src, notes: outline.slides[i].data.notes || [] }));
    const blob = await buildOdp(slides, { title: outline.meta.title });
    setProgress(100);
    hideProgress();
    const name = (outline.meta.title || "Masterclass") + ".odp";
    showDownload("ODP ready", blob, name);
    el.status.textContent = "✅ ODP ready";
  } catch(err){
    console.error('Failed to export ODP', err);
    hideProgress();
    el.status.textContent = "❌ ODP export failed";
  }
};

/*** --------------------- EXPORT: PDF --------------------- ***/
el.btnExportPDF.onclick = async ()=>{
  try {
    showProgress();
    el.status.textContent = "⏳ Rendering slides…";
    const { images, hotspotsBySlide } = await renderAllToImages({ lean: el.leanToggle.checked });
    el.status.textContent = "⏳ Building PDF…";
    setProgress(90);
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:"landscape", unit:"pt", format:[1280,720] });
    images.forEach((src,i)=>{
      if(i>0) doc.addPage([1280,720], "landscape");
      doc.addImage(src, "PNG", 0, 0, 1280, 720);
      (hotspotsBySlide[i]||[]).forEach(h=>{ doc.link(h.x, h.y, h.w, h.h, { url:h.url }); });
    });
    const name = (outline.meta.title || "Masterclass") + ".pdf";
    const blob = doc.output('blob');
    setProgress(100);
    hideProgress();
    showDownload("PDF ready", blob, name);
    el.status.textContent = "✅ PDF ready";
  } catch(err){
    console.error('Failed to export PDF', err);
    hideProgress();
    el.status.textContent = "❌ PDF export failed";
  }
};

// Drag-drop support on the textarea card
(function initDragDrop(){
  const card = document.querySelectorAll('.card')[0];
  card.addEventListener('dragover', e=>{ e.preventDefault(); card.style.outline="2px dashed #475569" });
  card.addEventListener('dragleave', ()=>{ card.style.outline="none" });
  card.addEventListener('drop', async e=>{
    e.preventDefault(); card.style.outline="none";
    const f = e.dataTransfer.files?.[0];
    if(!f) return;
    const txt = await f.text();
    el.pasteBox.value = txt;
    useText(txt);
  });
})();

refreshUI();
</script>
</body>
</html>

